(window["arcWidgetJsonp"]=window["arcWidgetJsonp"]||[]).push([["widget-sc-client"],{b07c:function(t,e,r){"use strict";r.r(e);var n=r("1da1"),s=r("ade3"),o=r("668b"),i=r("faa1"),c=r.n(i),a=r("517b"),u=r("5ff7");r("ac6a");function l(t,e){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),r.push.apply(r,n)}return r}function d(t){for(var e=1;e<arguments.length;e++){var r=null!=arguments[e]?arguments[e]:{};e%2?l(Object(r),!0).forEach((function(e){Object(s["a"])(t,e,r[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):l(Object(r)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))}))}return t}const p=r("7812"),f=(console.log,"overmind"),h={STATUS_REPORT:`${f}.statusReport`,UPDATE_SWARM_CONFIG:`${f}.updateSwarmConfig`,TASK_RESULT:`${f}.taskResult`},y=20,O={GET_SWARM_CONFIG:`${f}.get_swarm_config`},b=t=>`${f}.performTask.${t}`;function T(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const e=p.create(d({hostname:"socket.arc.io",port:Number("443")},t));return e}function g(t,e,r){return S.apply(this,arguments)}function S(){return S=Object(n["a"])((function*(t,e,r){var n,s=!0,i=!1;try{for(var c,a,u=Object(o["a"])(t.listener(e));c=yield u.next(),s=c.done,a=yield c.value,!s;s=!0){const t=a;r(t)}}catch(l){i=!0,n=l}finally{try{s||null==u.return||(yield u.return())}finally{if(i)throw n}}})),S.apply(this,arguments)}const j=(t,e)=>`${t}/${e}`;function k(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:y;const r=m(0,e),n=j(t,r);return n}function m(t,e){return Math.floor(Math.random()*(e-t+1)+t)}var R=r("a5a5"),v=r("c4d1"),_=r("8c32");const P=r("34eb")("arc:p2p-client"),E=(O.REPORT_NODE_STATUS,O.GET_SWARM_CONFIG);class w extends c.a{constructor(t){var e;super(),e=this,Object(s["a"])(this,"sendStatusReport",Object(a["a"])(Object(n["a"])((function*(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:R["f"];if(e.isDestroyed)return;const r=yield e.p2pClient.getStatusReport();r.config=e.config,r.tasks=e.tasks,P("statusReport",r);try{const n=h.STATUS_REPORT,s=k(n);yield e.socket.invokePublish(s,r)}catch(n){P(n),e.isFirstStatusReport&&(e.isFirstStatusReport=!1,yield e.sendStatusReportViaHTTP(r))}finally{clearTimeout(e.reportTimeoutId),e.reportTimeoutId=setTimeout(e.sendStatusReport,t)}})),1e4)),Object(s["a"])(this,"onSendReportsPublish",()=>{const t=1e3*I(0,60),e=I(0,R["f"]/2),r=Math.random()>.5?1:-1,n=R["f"]+e*r;setTimeout(()=>this.sendStatusReport(n),t)}),this.p2pClient=t,this.tasks=[],this.config={isAcceptingTasks:!0,maxFilesSeeding:5},this.isFirstStatusReport=!0,this.isDestroyed=!1,this.reportTimeoutId=null}_queueTask(t){var e=this;return Object(n["a"])((function*(){const r=e.tasks.length;e.tasks.push(t),0===r&&e._performTasks(e.tasks)}))()}_performTasks(t){var e=this;return Object(n["a"])((function*(){while(t.length>0){const r=t[0],n=yield e._performTask(r);r.returnResult&&e._sendTaskResult(r.id,n),t.shift()}e.sendStatusReport()}))()}_performTask(t){var e=this;return Object(n["a"])((function*(){P("Perfoming task",t);const r=t.timeout,n=void 0===r?5e3:r;let s;try{const r=e.p2pClient.performTask(t);s=yield Object(_["j"])(r,n)}catch(o){P("task err",o),v["a"].captureException(o),s=o instanceof Error?Object(_["d"])(o):`Error: ${o}`}return s}))()}_sendTaskResult(t,e){var r=this;return Object(n["a"])((function*(){const n=h.TASK_RESULT,s=k(n);r.socket.transmitPublish(s,{taskId:t,result:e})}))()}sendStatusReportViaHTTP(t){return Object(n["a"])((function*(){const e=`${u["a"].OVERMIND_ORIGIN}/api/statusReport`;yield fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({statusReport:t})})}))()}getSwarmConfig(){var t=this;return Object(n["a"])((function*(){let e={};try{e=yield t.session.call(E),Object.assign(t.config,e)}catch(r){P(r),v["a"].captureException(r)}return e}))()}_registerEvents(t){var e=this;g(t,"close",t=>{P("socket closed",t)}),g(t,"error",t=>{let e=t.error;P("socket err",e)});const r=this.p2pClient.nodeId,s=b(r);Object(n["a"])((function*(){var r,n=!0,i=!1;try{for(var c,a,u=Object(o["a"])(t.subscribe(s));c=yield u.next(),n=c.done,a=yield c.value,!n;n=!0){const t=a;e._queueTask(t)}}catch(l){i=!0,r=l}finally{try{n||null==u.return||(yield u.return())}finally{if(i)throw r}}}))()}connect(){var t=this;return Object(n["a"])((function*(){const e=t.p2pClient.nodeId,r=T({secure:!0,query:{nodeId:e}});t.socket=r,t._registerEvents(r);try{const t=yield r.listener("connect").once();P("Socket connected",t)}catch(n){P("Socket connection err",n)}}))()}disconnect(){this.socket.disconnect()}destroy(){this.isDestroyed=!0,this.disconnect(),this.removeAllListeners(),clearTimeout(this.reportTimeoutId)}}function I(t,e){return Math.floor(Math.random()*(e-t+1)+t)}e["default"]=w}}]);